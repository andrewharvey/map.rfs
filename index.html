<!DOCTYPE html>
<html>
<!--
  This file is licenced CC0 http://creativecommons.org/publicdomain/zero/1.0/
-->
<head>
        <title>map.rfs Major Incidents</title>

        <!-- support for mobile devices -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <link rel="stylesheet" href="/javascript/fonts-font-awsome/css/font-awesome.min.css" />
        <link rel="stylesheet" href="lib/leaflet-awsome-markers/leaflet.awesome-markers.css" />
        <link rel="stylesheet" href="/javascript/leaflet/leaflet.css" />
        <!--[if lte IE 8]><link rel="stylesheet" href="/javascript/leafelt/leaflet.ie.css" /><![endif]-->
        <!--[if lte IE 8]><link rel="stylesheet" href="/javascript/fonts-font-awsome/css/font-awesome-ie7.min.css" /><![endif]-->
        <script src="/javascript/leaflet/leaflet.js"></script>
        <script src="lib/leaflet-awsome-markers/leaflet.awesome-markers.min.js"></script>
        <script src="/javascript/jquery/jquery.min.js"></script>

        <!-- full screen map, no chrome -->
        <style>
                body {
                        padding: 0;
                        margin: 0;
                }
                html, body, #map {
                        height: 100%;
                }
        </style>
</head>
<body>
        <div id="map"></div>
        <script>
                /* set colors according to alert levels */
                var alertLevelStyle = {
                    'emergency': 'red',
                    'watchAndAct': 'orange',
                    'advice': 'yellow',
                    'notApplicable': 'grey'
                };

                var markerIcon = 'fire';

                /* now create the polygon styles */
                var emergencyPolygonStyle = {
                    'color': alertLevelStyle.emergency
                };
                var watchAndActPolygonStyle = {
                    'color': alertLevelStyle.watchAndAct
                };
                var advicePolygonStyle = {
                    'color': alertLevelStyle.advice
                };
                var notApplicablePolygonStyle = {
                    'color': alertLevelStyle.notApplicable
                };

                /* now create the markers */
                var emergencyIcon = L.AwesomeMarkers.icon({
                    icon: markerIcon,
                    color: alertLevelStyle.emergency 
                });
                var watchAndActIcon = L.AwesomeMarkers.icon({
                    icon: markerIcon,
                    color: alertLevelStyle.watchAndAct
                });
                var adviceIcon = L.AwesomeMarkers.icon({
                    icon: markerIcon,
                    color: alertLevelStyle.advice
                });
                var notApplicableIcon = L.AwesomeMarkers.icon({
                    icon: 'info',
                    color: alertLevelStyle.notApplicable
                });

                /* set the polygon style for this feature */
                function polygonStyle(feature) {
                    if (feature.properties && feature.properties.category) {
                        switch (feature.properties.category) {
                            case 'Emergency Warning':
                                return emergencyPolygonStyle;
                                break;
                            case 'Watch and Act':
                                return watchAndActPolygonStyle;
                                break;
                            case 'Advice':
                                return advicePolygonStyle;
                                break;
                            case 'Not Applicable':
                                return notApplicablePolygonStyle;
                                break;
                            default:
                                return {};
                        }
                    } else {
                        return {}; /* default style */
                    }
                }

                /* create a marker for this feature */
                function createMarker(feature, latlng) {
                    var icon = new L.Icon.Default();

                    if (feature.properties && feature.properties.category) {
                        switch (feature.properties.category) {
                            case 'Emergency Warning':
                                icon = emergencyIcon;
                                break;
                            case 'Watch and Act':
                                icon = watchAndActIcon;
                                break;
                            case 'Advice':
                                icon = adviceIcon;
                                break;
                            case 'Not Applicable':
                                icon = notApplicableIcon;
                                break;
                        }
                    }

                    return L.marker(latlng, { icon: icon });
                }

                /* for each feature from the GeoJSON do some extra tasks */
                function onEachFeature(feature, layer) {
                    /* create HTML content for the popup */
                    var html = '';
                    
                    if (feature.properties) {
                        if (feature.properties.title) {
                            html += '<h2>';

                            if (feature.properties.link)
                                html += '<a href="' + feature.properties.link + '">';

                            html += feature.properties.title;

                            if (feature.properties.link)
                                html += '</a>';

                            html += '</h2>';
                        }

                        if (feature.properties.description) {
                            html += '<p>' + feature.properties.description + '</p>';
                        }
                    }

                    /* bind a popup to the current feature layer using our
                       content we have just defined */
                    layer.bindPopup(html);

                    /* if the feature is a polygon also create a center marker
                       because tiny polygons are easily missed */
                    if (feature.geometry.type == 'Polygon') {
                        var centerMarker = createMarker(feature, layer.getBounds().getCenter()).addTo(map);
                        centerMarker.bindPopup(html);
                    }
                }

                /* create the leaflet map */
                var map = L.map('map');

                /* set the view for NSW ( S W N E ) */
                map.fitBounds([
                            [-37.614, 140.756],
                            [-28.071, 153.896]
                        ]);

                //L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                L.tileLayer('http://{s}.tile.tianjara.net/fosm/mapnik/{z}/{x}/{y}.png', {
                        maxZoom: 18,
                        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>'
                }).addTo(map);

                $.getJSON('majorIncidents.geojson', function (data) {
                        L.geoJson(data, {
                            style: polygonStyle,
                            pointToLayer: createMarker,
                            onEachFeature: onEachFeature
                        }).addTo(map);
                });
        </script>
</body>
</html>
